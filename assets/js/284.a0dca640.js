(window.webpackJsonp=window.webpackJsonp||[]).push([[284],{631:function(s,t,a){"use strict";a.r(t);var e=a(6),n=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("上一节我们了解到"),t("code",[s._v("render阶段")]),s._v("的工作可以分为“递”阶段和“归”阶段。其中“递”阶段会执行"),t("code",[s._v("beginWork")]),s._v("，“归”阶段会执行"),t("code",[s._v("completeWork")]),s._v("。这一节我们看看“递”阶段的"),t("code",[s._v("beginWork")]),s._v("方法究竟做了什么。")]),s._v(" "),t("h2",{attrs:{id:"方法概览"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#方法概览"}},[s._v("#")]),s._v(" 方法概览")]),s._v(" "),t("p",[s._v("可以从"),t("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberBeginWork.new.js#L3075",target:"_blank",rel:"noopener noreferrer"}},[s._v("源码这里"),t("OutboundLink")],1),s._v("看到"),t("code",[s._v("beginWork")]),s._v("的定义。整个方法大概有500行代码。")]),s._v(" "),t("p",[s._v("从上一节我们已经知道，"),t("code",[s._v("beginWork")]),s._v("的工作是传入"),t("code",[s._v("当前Fiber节点")]),s._v("，创建"),t("code",[s._v("子Fiber节点")]),s._v("，我们从传参来看看具体是如何做的。")]),s._v(" "),t("h3",{attrs:{id:"从传参看方法执行"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#从传参看方法执行"}},[s._v("#")]),s._v(" 从传参看方法执行")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("beginWork")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter"}},[t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("current")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Fiber "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("workInProgress")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Fiber"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("renderLanes")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lanes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Fiber "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略函数体")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("其中传参：")]),s._v(" "),t("ul",[t("li",[s._v("current：当前组件对应的"),t("code",[s._v("Fiber节点")]),s._v("在上一次更新时的"),t("code",[s._v("Fiber节点")]),s._v("，即"),t("code",[s._v("workInProgress.alternate")])]),s._v(" "),t("li",[s._v("workInProgress：当前组件对应的"),t("code",[s._v("Fiber节点")])]),s._v(" "),t("li",[s._v("renderLanes：优先级相关，在讲解"),t("code",[s._v("Scheduler")]),s._v("时再讲解")])]),s._v(" "),t("p",[s._v("从"),t("RouterLink",{attrs:{to:"/12.React技术揭秘/02.架构篇/01.第三章-Render阶段/doubleBuffer.html"}},[s._v("双缓存机制一节")]),s._v("我们知道，除"),t("RouterLink",{attrs:{to:"/12.React技术揭秘/02.架构篇/01.第三章-Render阶段/doubleBuffer.html#mount时"}},[t("code",[s._v("rootFiber")])]),s._v("以外， 组件"),t("code",[s._v("mount")]),s._v("时，由于是首次渲染，是不存在当前组件对应的"),t("code",[s._v("Fiber节点")]),s._v("在上一次更新时的"),t("code",[s._v("Fiber节点")]),s._v("，即"),t("code",[s._v("mount")]),s._v("时"),t("code",[s._v("current === null")]),s._v("。")],1),s._v(" "),t("p",[s._v("组件"),t("code",[s._v("update")]),s._v("时，由于之前已经"),t("code",[s._v("mount")]),s._v("过，所以"),t("code",[s._v("current !== null")]),s._v("。")]),s._v(" "),t("p",[s._v("所以我们可以通过"),t("code",[s._v("current === null ?")]),s._v("来区分组件是处于"),t("code",[s._v("mount")]),s._v("还是"),t("code",[s._v("update")]),s._v("。")]),s._v(" "),t("p",[s._v("基于此原因，"),t("code",[s._v("beginWork")]),s._v("的工作可以分为两部分：")]),s._v(" "),t("ul",[t("li",[t("p",[t("code",[s._v("update")]),s._v("时：如果"),t("code",[s._v("current")]),s._v("存在，在满足一定条件时可以复用"),t("code",[s._v("current")]),s._v("节点，这样就能克隆"),t("code",[s._v("current.child")]),s._v("作为"),t("code",[s._v("workInProgress.child")]),s._v("，而不需要新建"),t("code",[s._v("workInProgress.child")]),s._v("。")])]),s._v(" "),t("li",[t("p",[t("code",[s._v("mount")]),s._v("时：除"),t("code",[s._v("fiberRootNode")]),s._v("以外，"),t("code",[s._v("current === null")]),s._v("。会根据"),t("code",[s._v("fiber.tag")]),s._v("不同，创建不同类型的"),t("code",[s._v("子Fiber节点")])])])]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("beginWork")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter"}},[t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("current")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Fiber "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("workInProgress")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Fiber"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("renderLanes")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lanes")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Fiber "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// update时：如果current存在可能存在优化路径，可以复用current（即上一次更新的Fiber节点）")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("current "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!==")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 复用current")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("bailoutOnAlreadyFinishedWork")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n      current"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      workInProgress"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      renderLanes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    didReceiveUpdate "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// mount时：根据tag不同，创建不同的子Fiber节点")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("switch")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("workInProgress"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("tag"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("IndeterminateComponent")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" \n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("LazyComponent")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" \n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("FunctionComponent")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" \n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("ClassComponent")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" \n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("HostRoot")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("HostComponent")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("HostText")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略其他类型")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br")])]),t("h2",{attrs:{id:"update时"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#update时"}},[s._v("#")]),s._v(" update时")]),s._v(" "),t("p",[s._v("我们可以看到，满足如下情况时"),t("code",[s._v("didReceiveUpdate === false")]),s._v("（即可以直接复用前一次更新的"),t("code",[s._v("子Fiber")]),s._v("，不需要新建"),t("code",[s._v("子Fiber")]),s._v("）")]),s._v(" "),t("ol",[t("li",[t("code",[s._v("oldProps === newProps && workInProgress.type === current.type")]),s._v("，即"),t("code",[s._v("props")]),s._v("与"),t("code",[s._v("fiber.type")]),s._v("不变")]),s._v(" "),t("li",[t("code",[s._v("!includesSomeLane(renderLanes, updateLanes)")]),s._v("，即当前"),t("code",[s._v("Fiber节点")]),s._v("优先级不够，会在讲解"),t("code",[s._v("Scheduler")]),s._v("时介绍")])]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("current "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!==")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" oldProps "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" current"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("memoizedProps"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" newProps "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" workInProgress"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pendingProps"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n      oldProps "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!==")]),s._v(" newProps "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("hasLegacyContextChanged")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("__DEV__ "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("?")]),s._v(" workInProgress"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("type "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!==")]),s._v(" current"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("type "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      didReceiveUpdate "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("includesSomeLane")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("renderLanes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" updateLanes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      didReceiveUpdate "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("switch")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("workInProgress"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("tag"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 省略处理")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("bailoutOnAlreadyFinishedWork")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n        current"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        workInProgress"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        renderLanes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      didReceiveUpdate "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    didReceiveUpdate "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br")])]),t("h2",{attrs:{id:"mount时"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mount时"}},[s._v("#")]),s._v(" mount时")]),s._v(" "),t("p",[s._v("当不满足优化路径时，我们就进入第二部分，新建"),t("code",[s._v("子Fiber")]),s._v("。")]),s._v(" "),t("p",[s._v("我们可以看到，根据"),t("code",[s._v("fiber.tag")]),s._v("不同，进入不同类型"),t("code",[s._v("Fiber")]),s._v("的创建逻辑。")]),s._v(" "),t("blockquote",[t("p",[s._v("可以从"),t("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactWorkTags.js",target:"_blank",rel:"noopener noreferrer"}},[s._v("这里"),t("OutboundLink")],1),s._v("看到"),t("code",[s._v("tag")]),s._v("对应的组件类型")])]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// mount时：根据tag不同，创建不同的Fiber节点")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("switch")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("workInProgress"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("tag"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("IndeterminateComponent")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("LazyComponent")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("FunctionComponent")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("ClassComponent")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("HostRoot")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("HostComponent")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("HostText")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...省略其他类型")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br")])]),t("p",[s._v("对于我们常见的组件类型，如（"),t("code",[s._v("FunctionComponent")]),s._v("/"),t("code",[s._v("ClassComponent")]),s._v("/"),t("code",[s._v("HostComponent")]),s._v("），最终会进入"),t("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberBeginWork.new.js#L233",target:"_blank",rel:"noopener noreferrer"}},[s._v("reconcileChildren"),t("OutboundLink")],1),s._v("方法。")]),s._v(" "),t("h2",{attrs:{id:"reconcilechildren"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#reconcilechildren"}},[s._v("#")]),s._v(" reconcileChildren")]),s._v(" "),t("p",[s._v("从该函数名就能看出这是"),t("code",[s._v("Reconciler")]),s._v("模块的核心部分。那么他究竟做了什么呢？")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("对于"),t("code",[s._v("mount")]),s._v("的组件，他会创建新的"),t("code",[s._v("子Fiber节点")])])]),s._v(" "),t("li",[t("p",[s._v("对于"),t("code",[s._v("update")]),s._v("的组件，他会将当前组件与该组件在上次更新时对应的"),t("code",[s._v("Fiber节点")]),s._v("比较（也就是俗称的"),t("code",[s._v("Diff")]),s._v("算法），将比较的结果生成新"),t("code",[s._v("Fiber节点")])])])]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("reconcileChildren")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token parameter"}},[t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("current")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Fiber "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("workInProgress")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Fiber"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("nextChildren")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" any"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("renderLanes")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" Lanes")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("current "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("===")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 对于mount的组件")]),s._v("\n    workInProgress"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("child "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mountChildFibers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n      workInProgress"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      nextChildren"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      renderLanes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 对于update的组件")]),s._v("\n    workInProgress"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("child "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("reconcileChildFibers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n      workInProgress"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      current"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("child"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      nextChildren"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      renderLanes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br")])]),t("p",[s._v("从代码可以看出，和"),t("code",[s._v("beginWork")]),s._v("一样，他也是通过"),t("code",[s._v("current === null ?")]),s._v("区分"),t("code",[s._v("mount")]),s._v("与"),t("code",[s._v("update")]),s._v("。")]),s._v(" "),t("p",[s._v("不论走哪个逻辑，最终他会生成新的子"),t("code",[s._v("Fiber节点")]),s._v("并赋值给"),t("code",[s._v("workInProgress.child")]),s._v("，作为本次"),t("code",[s._v("beginWork")]),t("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberBeginWork.new.js#L1158",target:"_blank",rel:"noopener noreferrer"}},[s._v("返回值"),t("OutboundLink")],1),s._v("，并作为下次"),t("code",[s._v("performUnitOfWork")]),s._v("执行时"),t("code",[s._v("workInProgress")]),s._v("的"),t("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L1702",target:"_blank",rel:"noopener noreferrer"}},[s._v("传参"),t("OutboundLink")],1),s._v("。")]),s._v(" "),t("div",{staticClass:"custom-block warning"},[t("p",{staticClass:"custom-block-title"},[s._v("注意")]),s._v(" "),t("p",[s._v("值得一提的是，"),t("code",[s._v("mountChildFibers")]),s._v("与"),t("code",[s._v("reconcileChildFibers")]),s._v("这两个方法的逻辑基本一致。唯一的区别是："),t("code",[s._v("reconcileChildFibers")]),s._v("会为生成的"),t("code",[s._v("Fiber节点")]),s._v("带上"),t("code",[s._v("effectTag")]),s._v("属性，而"),t("code",[s._v("mountChildFibers")]),s._v("不会。")])]),s._v(" "),t("h2",{attrs:{id:"effecttag"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#effecttag"}},[s._v("#")]),s._v(" effectTag")]),s._v(" "),t("p",[s._v("我们知道，"),t("code",[s._v("render阶段")]),s._v("的工作是在内存中进行，当工作结束后会通知"),t("code",[s._v("Renderer")]),s._v("需要执行的"),t("code",[s._v("DOM")]),s._v("操作。要执行"),t("code",[s._v("DOM")]),s._v("操作的具体类型就保存在"),t("code",[s._v("fiber.effectTag")]),s._v("中。")]),s._v(" "),t("blockquote",[t("p",[s._v("你可以从"),t("a",{attrs:{href:"https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/react-reconciler/src/ReactSideEffectTags.js",target:"_blank",rel:"noopener noreferrer"}},[s._v("这里"),t("OutboundLink")],1),s._v("看到"),t("code",[s._v("effectTag")]),s._v("对应的"),t("code",[s._v("DOM")]),s._v("操作")])]),s._v(" "),t("p",[s._v("比如：")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// DOM需要插入到页面中")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" Placement "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*                */")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0b00000000000010")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// DOM需要更新")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" Update "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*                   */")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0b00000000000100")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// DOM需要插入到页面中并更新")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" PlacementAndUpdate "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*       */")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0b00000000000110")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// DOM需要删除")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("export")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" Deletion "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*                 */")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0b00000000001000")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("blockquote",[t("p",[s._v("通过二进制表示"),t("code",[s._v("effectTag")]),s._v("，可以方便的使用位操作为"),t("code",[s._v("fiber.effectTag")]),s._v("赋值多个"),t("code",[s._v("effect")]),s._v("。")])]),s._v(" "),t("p",[s._v("那么，如果要通知"),t("code",[s._v("Renderer")]),s._v("将"),t("code",[s._v("Fiber节点")]),s._v("对应的"),t("code",[s._v("DOM节点")]),s._v("插入页面中，需要满足两个条件：")]),s._v(" "),t("ol",[t("li",[t("p",[t("code",[s._v("fiber.stateNode")]),s._v("存在，即"),t("code",[s._v("Fiber节点")]),s._v("中保存了对应的"),t("code",[s._v("DOM节点")])])]),s._v(" "),t("li",[t("p",[t("code",[s._v("(fiber.effectTag & Placement) !== 0")]),s._v("，即"),t("code",[s._v("Fiber节点")]),s._v("存在"),t("code",[s._v("Placement effectTag")])])])]),s._v(" "),t("p",[s._v("我们知道，"),t("code",[s._v("mount")]),s._v("时，"),t("code",[s._v("fiber.stateNode === null")]),s._v("，且在"),t("code",[s._v("reconcileChildren")]),s._v("中调用的"),t("code",[s._v("mountChildFibers")]),s._v("不会为"),t("code",[s._v("Fiber节点")]),s._v("赋值"),t("code",[s._v("effectTag")]),s._v("。那么首屏渲染如何完成呢？")]),s._v(" "),t("p",[s._v("针对第一个问题，"),t("code",[s._v("fiber.stateNode")]),s._v("会在"),t("code",[s._v("completeWork")]),s._v("中创建，我们会在下一节介绍。")]),s._v(" "),t("p",[s._v("第二个问题的答案十分巧妙：假设"),t("code",[s._v("mountChildFibers")]),s._v("也会赋值"),t("code",[s._v("effectTag")]),s._v("，那么可以预见"),t("code",[s._v("mount")]),s._v("时整棵"),t("code",[s._v("Fiber树")]),s._v("所有节点都会有"),t("code",[s._v("Placement effectTag")]),s._v("。那么"),t("code",[s._v("commit阶段")]),s._v("在执行"),t("code",[s._v("DOM")]),s._v("操作时每个节点都会执行一次插入操作，这样大量的"),t("code",[s._v("DOM")]),s._v("操作是极低效的。")]),s._v(" "),t("p",[s._v("为了解决这个问题，在"),t("code",[s._v("mount")]),s._v("时只有"),t("code",[s._v("rootFiber")]),s._v("会赋值"),t("code",[s._v("Placement effectTag")]),s._v("，在"),t("code",[s._v("commit阶段")]),s._v("只会执行一次插入操作。")]),s._v(" "),t("details",{staticClass:"custom-block details"},[t("summary",[s._v("根Fiber节点 Demo")]),s._v(" "),t("p",[s._v("借用上一节的Demo，第一个进入"),t("code",[s._v("beginWork")]),s._v("方法的"),t("code",[s._v("Fiber节点")]),s._v("就是"),t("code",[s._v("rootFiber")]),s._v("，他的"),t("code",[s._v("alternate")]),s._v("指向"),t("code",[s._v("current rootFiber")]),s._v("（即他存在"),t("code",[s._v("current")]),s._v("）。")]),s._v(" "),t("blockquote",[t("p",[s._v("为什么"),t("code",[s._v("rootFiber")]),s._v("节点存在"),t("code",[s._v("current")]),s._v("（即"),t("code",[s._v("rootFiber.alternate")]),s._v("），我们在"),t("RouterLink",{attrs:{to:"/12.React技术揭秘/02.架构篇/01.第三章-Render阶段/doubleBuffer.html"}},[s._v("双缓存机制一节mount时的第二步")]),s._v("已经讲过")],1)]),s._v(" "),t("p",[s._v("由于存在"),t("code",[s._v("current")]),s._v("，"),t("code",[s._v("rootFiber")]),s._v("在"),t("code",[s._v("reconcileChildren")]),s._v("时会走"),t("code",[s._v("reconcileChildFibers")]),s._v("逻辑。")]),s._v(" "),t("p",[s._v("而之后通过"),t("code",[s._v("beginWork")]),s._v("创建的"),t("code",[s._v("Fiber节点")]),s._v("是不存在"),t("code",[s._v("current")]),s._v("的（即 "),t("code",[s._v("fiber.alternate === null")]),s._v("），会走"),t("code",[s._v("mountChildFibers")]),s._v("逻辑")]),s._v(" "),t("p",[t("RouterLink",{attrs:{to:"/12.React技术揭秘/02.架构篇/me.html"}},[s._v("关注公众号")]),s._v("，后台回复"),t("strong",[s._v("531")]),s._v("获得在线Demo地址")],1)]),s._v(" "),t("h2",{attrs:{id:"参考资料"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[s._v("#")]),s._v(" 参考资料")]),s._v(" "),t("p",[t("code",[s._v("beginWork")]),s._v("流程图")]),s._v(" "),t("img",{attrs:{src:s.$withBase("/img/beginWork.png"),alt:"beginWork流程图"}})])}),[],!1,null,null,null);t.default=n.exports}}]);