(window.webpackJsonp=window.webpackJsonp||[]).push([[296],{645:function(s,t,e){"use strict";e.r(t);var a=e(6),r=Object(a.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("通过"),t("RouterLink",{attrs:{to:"/12.React技术揭秘/03.实现篇/02.第六章-状态更新/mental.html"}},[s._v("更新的心智模型")]),s._v("，我们了解到"),t("code",[s._v("更新")]),s._v("具有"),t("code",[s._v("优先级")]),s._v("。")],1),s._v(" "),t("p",[s._v("那么什么是"),t("code",[s._v("优先级")]),s._v("？"),t("code",[s._v("优先级")]),s._v("以什么为依据？如何通过"),t("code",[s._v("优先级")]),s._v("决定哪个状态应该先被更新？")]),s._v(" "),t("p",[s._v("本节我们会详细讲解。")]),s._v(" "),t("h2",{attrs:{id:"什么是优先级"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#什么是优先级"}},[s._v("#")]),s._v(" 什么是优先级")]),s._v(" "),t("p",[s._v("在"),t("RouterLink",{attrs:{to:"/12.React技术揭秘/03.实现篇/preparation/idea.html#理解-响应自然"}},[s._v("React理念一节")]),s._v("我们聊到"),t("code",[s._v("React")]),s._v("将人机交互研究的结果整合到真实的"),t("code",[s._v("UI")]),s._v("中。具体到"),t("code",[s._v("React")]),s._v("运行上这是什么意思呢？")],1),s._v(" "),t("p",[t("code",[s._v("状态更新")]),s._v("由"),t("code",[s._v("用户交互")]),s._v("产生，用户心里对"),t("code",[s._v("交互")]),s._v("执行顺序有个预期。"),t("code",[s._v("React")]),s._v("根据"),t("code",[s._v("人机交互研究的结果")]),s._v("中用户对"),t("code",[s._v("交互")]),s._v("的预期顺序为"),t("code",[s._v("交互")]),s._v("产生的"),t("code",[s._v("状态更新")]),s._v("赋予不同优先级。")]),s._v(" "),t("p",[s._v("具体如下：")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("生命周期方法：同步执行。")])]),s._v(" "),t("li",[t("p",[s._v("受控的用户输入：比如输入框内输入文字，同步执行。")])]),s._v(" "),t("li",[t("p",[s._v("交互事件：比如动画，高优先级执行。")])]),s._v(" "),t("li",[t("p",[s._v("其他：比如数据请求，低优先级执行。")])])]),s._v(" "),t("h2",{attrs:{id:"如何调度优先级"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#如何调度优先级"}},[s._v("#")]),s._v(" 如何调度优先级")]),s._v(" "),t("p",[s._v("我们在"),t("RouterLink",{attrs:{to:"/12.React技术揭秘/03.实现篇/preparation/newConstructure.html"}},[s._v("新的React结构一节")]),s._v("讲到，"),t("code",[s._v("React")]),s._v("通过"),t("code",[s._v("Scheduler")]),s._v("调度任务。")],1),s._v(" "),t("p",[s._v("具体到代码，每当需要调度任务时，"),t("code",[s._v("React")]),s._v("会调用"),t("code",[s._v("Scheduler")]),s._v("提供的方法"),t("code",[s._v("runWithPriority")]),s._v("。")]),s._v(" "),t("p",[s._v("该方法接收一个"),t("code",[s._v("优先级")]),s._v("常量与一个"),t("code",[s._v("回调函数")]),s._v("作为参数。"),t("code",[s._v("回调函数")]),s._v("会以"),t("code",[s._v("优先级")]),s._v("高低为顺序排列在一个"),t("code",[s._v("定时器")]),s._v("中并在合适的时间触发。")]),s._v(" "),t("p",[s._v("对于更新来讲，传递的"),t("code",[s._v("回调函数")]),s._v("一般为"),t("RouterLink",{attrs:{to:"/12.React技术揭秘/03.实现篇/02.第六章-状态更新/prepare.html#render阶段的开始"}},[s._v("状态更新流程概览一节")]),s._v("讲到的"),t("code",[s._v("render阶段的入口函数")]),s._v("。")],1),s._v(" "),t("blockquote",[t("p",[s._v("你可以在"),t("a",{attrs:{href:"https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/scheduler/src/Scheduler.js#L217",target:"_blank",rel:"noopener noreferrer"}},[s._v("==unstable_runWithPriority== 这里"),t("OutboundLink")],1),s._v("看到"),t("code",[s._v("runWithPriority")]),s._v("方法的定义。在"),t("a",{attrs:{href:"https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/scheduler/src/SchedulerPriorities.js",target:"_blank",rel:"noopener noreferrer"}},[s._v("这里"),t("OutboundLink")],1),s._v("看到"),t("code",[s._v("Scheduler")]),s._v("对优先级常量的定义。")])]),s._v(" "),t("h2",{attrs:{id:"例子"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#例子"}},[s._v("#")]),s._v(" 例子")]),s._v(" "),t("p",[s._v("优先级最终会反映到"),t("code",[s._v("update.lane")]),s._v("变量上。当前我们只需要知道这个变量能够区分"),t("code",[s._v("Update")]),s._v("的优先级。")]),s._v(" "),t("p",[s._v("接下来我们通过一个例子结合上一节介绍的"),t("code",[s._v("Update")]),s._v("相关字段讲解优先级如何决定更新的顺序。")]),s._v(" "),t("blockquote",[t("p",[s._v("该例子来自"),t("a",{attrs:{href:"https://twitter.com/acdlite/status/978412930973687808",target:"_blank",rel:"noopener noreferrer"}},[s._v("React Core Team Andrew向网友讲解Update工作流程的推文"),t("OutboundLink")],1)])]),s._v(" "),t("img",{attrs:{src:s.$withBase("/img/update-process.png"),alt:"优先级如何决定更新的顺序"}}),s._v(" "),t("p",[s._v("在这个例子中，有两个"),t("code",[s._v("Update")]),s._v("。我们将“关闭黑夜模式”产生的"),t("code",[s._v("Update")]),s._v("称为"),t("code",[s._v("u1")]),s._v("，输入字母“I”产生的"),t("code",[s._v("Update")]),s._v("称为"),t("code",[s._v("u2")]),s._v("。")]),s._v(" "),t("p",[s._v("其中"),t("code",[s._v("u1")]),s._v("先触发并进入"),t("code",[s._v("render阶段")]),s._v("。其优先级较低，执行时间较长。此时：")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[s._v("fiber"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("updateQueue "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("baseState")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("blackTheme")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("text")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'H'")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("firstBaseUpdate")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("lastBaseUpdate")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("shared")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("pending")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" u1\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("effects")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("p",[s._v("在"),t("code",[s._v("u1")]),s._v("完成"),t("code",[s._v("render阶段")]),s._v("前用户通过键盘输入字母“I”，产生了"),t("code",[s._v("u2")]),s._v("。"),t("code",[s._v("u2")]),s._v("属于"),t("strong",[s._v("受控的用户输入")]),s._v("，优先级高于"),t("code",[s._v("u1")]),s._v("，于是中断"),t("code",[s._v("u1")]),s._v("产生的"),t("code",[s._v("render阶段")]),s._v("。")]),s._v(" "),t("p",[s._v("此时：")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[s._v("fiber"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("updateQueue"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("shared"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pending "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("===")]),s._v(" u2 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" u1\n                                     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("^")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n                                     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("________"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 即")]),s._v("\nu2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("next "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("===")]),s._v(" u1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nu1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("next "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("===")]),s._v(" u2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("其中"),t("code",[s._v("u2")]),s._v("优先级高于"),t("code",[s._v("u1")]),s._v("。")]),s._v(" "),t("p",[s._v("接下来进入"),t("code",[s._v("u2")]),s._v("产生的"),t("code",[s._v("render阶段")]),s._v("。")]),s._v(" "),t("p",[s._v("在"),t("code",[s._v("processUpdateQueue")]),s._v("方法中，"),t("code",[s._v("shared.pending")]),s._v("环状链表会被剪开并拼接在"),t("code",[s._v("baseUpdate")]),s._v("后面。")]),s._v(" "),t("p",[s._v("需要明确一点，"),t("code",[s._v("shared.pending")]),s._v("指向最后一个"),t("code",[s._v("pending")]),s._v("的"),t("code",[s._v("update")]),s._v("，所以实际执行时"),t("code",[s._v("update")]),s._v("的顺序为：")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[s._v("u1 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),s._v(" u2\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("接下来遍历"),t("code",[s._v("baseUpdate")]),s._v("，处理优先级合适的"),t("code",[s._v("Update")]),s._v("（这一次处理的是更高优的"),t("code",[s._v("u2")]),s._v("）。")]),s._v(" "),t("p",[s._v("由于"),t("code",[s._v("u2")]),s._v("不是"),t("code",[s._v("baseUpdate")]),s._v("中的第一个"),t("code",[s._v("update")]),s._v("，在其之前的"),t("code",[s._v("u1")]),s._v("由于优先级不够被跳过。")]),s._v(" "),t("p",[t("code",[s._v("update")]),s._v("之间可能有依赖关系，所以被跳过的"),t("code",[s._v("update")]),s._v("及其后面所有"),t("code",[s._v("update")]),s._v("会成为下次更新的"),t("code",[s._v("baseUpdate")]),s._v("。（即"),t("code",[s._v("u1 -- u2")]),s._v("）。")]),s._v(" "),t("p",[s._v("最终"),t("code",[s._v("u2")]),s._v("完成"),t("code",[s._v("render - commit阶段")]),s._v("。")]),s._v(" "),t("p",[s._v("此时：")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[s._v("fiber"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("updateQueue "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("baseState")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("blackTheme")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("text")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'HI'")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("firstBaseUpdate")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" u1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("lastBaseUpdate")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" u2\n  "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("shared")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("pending")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("effects")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("p",[s._v("在"),t("code",[s._v("commit")]),s._v("阶段结尾会再调度一次更新。在该次更新中会基于"),t("code",[s._v("baseState")]),s._v("中"),t("code",[s._v("firstBaseUpdate")]),s._v("保存的"),t("code",[s._v("u1")]),s._v("，开启一次新的"),t("code",[s._v("render阶段")]),s._v("。")]),s._v(" "),t("p",[s._v("最终两次"),t("code",[s._v("Update")]),s._v("都完成后的结果如下：")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[s._v("fiber"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("updateQueue "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("baseState")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("blackTheme")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("text")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'HI'")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("firstBaseUpdate")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("lastBaseUpdate")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("shared")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("pending")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("effects")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("p",[s._v("我们可以看见，"),t("code",[s._v("u2")]),s._v("对应的更新执行了两次，相应的"),t("code",[s._v("render阶段")]),s._v("的生命周期勾子"),t("code",[s._v("componentWillXXX")]),s._v("也会触发两次。这也是为什么这些勾子会被标记为"),t("code",[s._v("unsafe_")]),s._v("。")]),s._v(" "),t("h2",{attrs:{id:"如何保证状态正确"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#如何保证状态正确"}},[s._v("#")]),s._v(" 如何保证状态正确")]),s._v(" "),t("p",[s._v("现在我们基本掌握了"),t("code",[s._v("updateQueue")]),s._v("的工作流程。还有两个疑问：")]),s._v(" "),t("ul",[t("li",[t("p",[t("code",[s._v("render阶段")]),s._v("可能被中断。如何保证"),t("code",[s._v("updateQueue")]),s._v("中保存的"),t("code",[s._v("Update")]),s._v("不丢失？")])]),s._v(" "),t("li",[t("p",[s._v("有时候当前"),t("code",[s._v("状态")]),s._v("需要依赖前一个"),t("code",[s._v("状态")]),s._v("。如何在支持跳过"),t("code",[s._v("低优先级状态")]),s._v("的同时保证"),t("strong",[s._v("状态依赖的连续性")]),s._v("？")])])]),s._v(" "),t("p",[s._v("我们分别讲解下。")]),s._v(" "),t("h3",{attrs:{id:"如何保证update不丢失"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#如何保证update不丢失"}},[s._v("#")]),s._v(" 如何保证"),t("code",[s._v("Update")]),s._v("不丢失")]),s._v(" "),t("p",[s._v("在"),t("RouterLink",{attrs:{to:"/12.React技术揭秘/03.实现篇/02.第六章-状态更新/update.html#例子"}},[s._v("上一节例子")]),s._v("中我们讲到，在"),t("code",[s._v("render阶段")]),s._v("，"),t("code",[s._v("shared.pending")]),s._v("的环被剪开并连接在"),t("code",[s._v("updateQueue.lastBaseUpdate")]),s._v("后面。")],1),s._v(" "),t("p",[s._v("实际上"),t("code",[s._v("shared.pending")]),s._v("会被同时连接在"),t("code",[s._v("workInProgress updateQueue.lastBaseUpdate")]),s._v("与"),t("code",[s._v("current updateQueue.lastBaseUpdate")]),s._v("后面。")]),s._v(" "),t("blockquote",[t("p",[s._v("具体代码见"),t("a",{attrs:{href:"https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactUpdateQueue.new.js#L424",target:"_blank",rel:"noopener noreferrer"}},[s._v("这里"),t("OutboundLink")],1)])]),s._v(" "),t("p",[s._v("当"),t("code",[s._v("render阶段")]),s._v("被中断后重新开始时，会基于"),t("code",[s._v("current updateQueue")]),s._v("克隆出"),t("code",[s._v("workInProgress updateQueue")]),s._v("。由于"),t("code",[s._v("current updateQueue.lastBaseUpdate")]),s._v("已经保存了上一次的"),t("code",[s._v("Update")]),s._v("，所以不会丢失。")]),s._v(" "),t("p",[s._v("当"),t("code",[s._v("commit阶段")]),s._v("完成渲染，由于"),t("code",[s._v("workInProgress updateQueue.lastBaseUpdate")]),s._v("中保存了上一次的"),t("code",[s._v("Update")]),s._v("，所以 "),t("code",[s._v("workInProgress Fiber树")]),s._v("变成"),t("code",[s._v("current Fiber树")]),s._v("后也不会造成"),t("code",[s._v("Update")]),s._v("丢失。")]),s._v(" "),t("h3",{attrs:{id:"如何保证状态依赖的连续性"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#如何保证状态依赖的连续性"}},[s._v("#")]),s._v(" 如何保证状态依赖的连续性")]),s._v(" "),t("p",[s._v("当某个"),t("code",[s._v("Update")]),s._v("由于优先级低而被跳过时，保存在"),t("code",[s._v("baseUpdate")]),s._v("中的不仅是该"),t("code",[s._v("Update")]),s._v("，还包括链表中该"),t("code",[s._v("Update")]),s._v("之后的所有"),t("code",[s._v("Update")]),s._v("。")]),s._v(" "),t("p",[s._v("考虑如下例子：")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("baseState")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("''")]),s._v("\nshared"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pending"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("A1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("B2")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("C1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("D2")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("其中"),t("code",[s._v("字母")]),s._v("代表该"),t("code",[s._v("Update")]),s._v("要在页面插入的字母，"),t("code",[s._v("数字")]),s._v("代表"),t("code",[s._v("优先级")]),s._v("，值越低"),t("code",[s._v("优先级")]),s._v("越高。")]),s._v(" "),t("p",[s._v("第一次"),t("code",[s._v("render")]),s._v("，"),t("code",[s._v("优先级")]),s._v("为1。")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("baseState")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("''")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("baseUpdate")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("render阶段使用的Update")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("A1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("C1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("memoizedState")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'AC'")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("其中"),t("code",[s._v("B2")]),s._v("由于优先级为2，低于当前优先级，所以他及其后面的所有"),t("code",[s._v("Update")]),s._v("会被保存在"),t("code",[s._v("baseUpdate")]),s._v("中作为下次更新的"),t("code",[s._v("Update")]),s._v("（即"),t("code",[s._v("B2 C1 D2")]),s._v("）。")]),s._v(" "),t("p",[s._v("这么做是为了保持"),t("code",[s._v("状态")]),s._v("的前后依赖顺序。")]),s._v(" "),t("p",[s._v("第二次"),t("code",[s._v("render")]),s._v("，"),t("code",[s._v("优先级")]),s._v("为2。")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("baseState")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'A'")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("baseUpdate")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("B2")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("C1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("--")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("D2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("render阶段使用的Update")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("B2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("C1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("D2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("memoizedState")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ABCD'")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("注意这里"),t("code",[s._v("baseState")]),s._v("并不是上一次更新的"),t("code",[s._v("memoizedState")]),s._v("。这是由于"),t("code",[s._v("B2")]),s._v("被跳过了。")]),s._v(" "),t("p",[s._v("即当有"),t("code",[s._v("Update")]),s._v("被跳过时，"),t("code",[s._v("下次更新的baseState !== 上次更新的memoizedState")]),s._v("。")]),s._v(" "),t("blockquote",[t("p",[s._v("跳过"),t("code",[s._v("B2")]),s._v("的逻辑见"),t("a",{attrs:{href:"https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactUpdateQueue.new.js#L479",target:"_blank",rel:"noopener noreferrer"}},[s._v("这里"),t("OutboundLink")],1)])]),s._v(" "),t("p",[s._v("通过以上例子我们可以发现，"),t("code",[s._v("React")]),s._v("保证最终的状态一定和用户触发的"),t("code",[s._v("交互")]),s._v("一致，但是中间过程"),t("code",[s._v("状态")]),s._v("可能由于设备不同而不同。")]),s._v(" "),t("details",{staticClass:"custom-block details"},[t("summary",[s._v("高优先级任务打断低优先级任务Demo")]),s._v(" "),t("p",[t("RouterLink",{attrs:{to:"/12.React技术揭秘/03.实现篇/me.html"}},[s._v("关注公众号")]),s._v("，后台回复"),t("strong",[s._v("815")]),s._v("获得在线Demo地址")],1)]),s._v(" "),t("h2",{attrs:{id:"参考资料"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[s._v("#")]),s._v(" 参考资料")]),s._v(" "),t("p",[t("a",{attrs:{href:"https://juejin.im/post/5f05a3e25188252e5c576cdb",target:"_blank",rel:"noopener noreferrer"}},[s._v("深入源码剖析componentWillXXX为什么UNSAFE"),t("OutboundLink")],1)]),s._v(" "),t("p",[t("a",{attrs:{href:"https://github.com/facebook/react/blob/970fa122d8188bafa600e9b5214833487fbf1092/packages/react-reconciler/src/ReactUpdateQueue.new.js#L10",target:"_blank",rel:"noopener noreferrer"}},[s._v("React源码中讲解Update工作流程及优先级的注释"),t("OutboundLink")],1)]),s._v(" "),t("p",[t("a",{attrs:{href:"https://twitter.com/acdlite/status/978412930973687808",target:"_blank",rel:"noopener noreferrer"}},[s._v("React Core Team Andrew向网友讲解Update工作流程的推文"),t("OutboundLink")],1)])])}),[],!1,null,null,null);t.default=r.exports}}]);