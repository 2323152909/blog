(window.webpackJsonp=window.webpackJsonp||[]).push([[276],{625:function(s,t,a){"use strict";a.r(t);var n=a(6),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("React核心团队成员"),t("a",{attrs:{href:"https://github.com/sebmarkbage/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Sebastian Markbåge"),t("OutboundLink")],1),s._v("（"),t("code",[s._v("React Hooks")]),s._v("的发明者）曾说：我们在"),t("code",[s._v("React")]),s._v("中做的就是践行"),t("code",[s._v("代数效应")]),s._v("（Algebraic Effects）。")]),s._v(" "),t("p",[s._v("那么，"),t("code",[s._v("代数效应")]),s._v("是什么呢？他和"),t("code",[s._v("React")]),s._v("有什么关系呢。")]),s._v(" "),t("h2",{attrs:{id:"什么是代数效应"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#什么是代数效应"}},[s._v("#")]),s._v(" 什么是代数效应")]),s._v(" "),t("p",[t("code",[s._v("代数效应")]),s._v("是"),t("code",[s._v("函数式编程")]),s._v("中的一个概念，用于将"),t("code",[s._v("副作用")]),s._v("从"),t("code",[s._v("函数")]),s._v("调用中分离。")]),s._v(" "),t("p",[s._v("接下来我们用"),t("code",[s._v("虚构的语法")]),s._v("来解释。")]),s._v(" "),t("p",[s._v("假设我们有一个函数"),t("code",[s._v("getTotalPicNum")]),s._v("，传入2个"),t("code",[s._v("用户名称")]),s._v("后，分别查找该用户在平台保存的图片数量，最后将图片数量相加后返回。")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getTotalPicNum")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("user1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" user2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" picNum1 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getPicNum")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("user1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" picNum2 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getPicNum")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("user2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" picNum1 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" picNum2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("在"),t("code",[s._v("getTotalPicNum")]),s._v("中，我们不关注"),t("code",[s._v("getPicNum")]),s._v("的实现，只在乎“获取到两个数字后将他们相加的结果返回”这一过程。")]),s._v(" "),t("p",[s._v("接下来我们来实现"),t("code",[s._v("getPicNum")]),s._v("。")]),s._v(" "),t("p",[s._v('"用户在平台保存的图片数量"是保存在服务器中的。所以，为了获取该值，我们需要发起异步请求。')]),s._v(" "),t("p",[s._v("为了尽量保持"),t("code",[s._v("getTotalPicNum")]),s._v("的调用方式不变，我们首先想到了使用"),t("code",[s._v("async await")]),s._v("：")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("async")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getTotalPicNum")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("user1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" user2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" picNum1 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("await")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getPicNum")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("user1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" picNum2 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("await")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getPicNum")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("user2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" picNum1 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" picNum2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("但是，"),t("code",[s._v("async await")]),s._v("是有"),t("code",[s._v("传染性")]),s._v("的 —— 当一个函数变为"),t("code",[s._v("async")]),s._v("后，这意味着调用他的函数也需要是"),t("code",[s._v("async")]),s._v("，这破坏了"),t("code",[s._v("getTotalPicNum")]),s._v("的同步特性。")]),s._v(" "),t("p",[s._v("有没有什么办法能保持"),t("code",[s._v("getTotalPicNum")]),s._v("保持现有调用方式不变的情况下实现异步请求呢？")]),s._v(" "),t("p",[s._v("没有。不过我们可以"),t("code",[s._v("虚构")]),s._v("一个。")]),s._v(" "),t("p",[s._v("我们虚构一个类似"),t("code",[s._v("try...catch")]),s._v("的语法 —— "),t("code",[s._v("try...handle")]),s._v("与两个操作符"),t("code",[s._v("perform")]),s._v("、"),t("code",[s._v("resume")]),s._v("。")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getPicNum")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" picNum "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" perform name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" picNum"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getTotalPicNum")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'kaSong'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'xiaoMing'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("handle")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("who")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("switch")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("who"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'kaSong'")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n      resume "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("with")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("230")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'xiaoMing'")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n      resume "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("with")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("122")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n      resume "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("with")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("p",[s._v("当执行到"),t("code",[s._v("getTotalPicNum")]),s._v("内部的"),t("code",[s._v("getPicNum")]),s._v("方法时，会执行"),t("code",[s._v("perform name")]),s._v("。")]),s._v(" "),t("p",[s._v("此时函数调用栈会从"),t("code",[s._v("getPicNum")]),s._v("方法内跳出，被最近一个"),t("code",[s._v("try...handle")]),s._v("捕获。类似"),t("code",[s._v("throw Error")]),s._v("后被最近一个"),t("code",[s._v("try...catch")]),s._v("捕获。")]),s._v(" "),t("p",[s._v("类似"),t("code",[s._v("throw Error")]),s._v("后"),t("code",[s._v("Error")]),s._v("会作为"),t("code",[s._v("catch")]),s._v("的参数，"),t("code",[s._v("perform name")]),s._v("后"),t("code",[s._v("name")]),s._v("会作为"),t("code",[s._v("handle")]),s._v("的参数。")]),s._v(" "),t("p",[s._v("与"),t("code",[s._v("try...catch")]),s._v("最大的不同在于：当"),t("code",[s._v("Error")]),s._v("被"),t("code",[s._v("catch")]),s._v("捕获后，之前的调用栈就销毁了。而"),t("code",[s._v("handle")]),s._v("执行"),t("code",[s._v("resume")]),s._v("后会回到之前"),t("code",[s._v("perform")]),s._v("的调用栈。")]),s._v(" "),t("p",[s._v("对于"),t("code",[s._v("case 'kaSong'")]),s._v("，执行完"),t("code",[s._v("resume with 230;")]),s._v("后调用栈会回到"),t("code",[s._v("getPicNum")]),s._v("，此时"),t("code",[s._v("picNum === 230")])]),s._v(" "),t("div",{staticClass:"custom-block warning"},[t("p",{staticClass:"custom-block-title"},[s._v("注意")]),s._v(" "),t("p",[s._v("再次申明，"),t("code",[s._v("try...handle")]),s._v("的语法是虚构的，只是为了演示"),t("code",[s._v("代数效应")]),s._v("的思想。")])]),s._v(" "),t("p",[s._v("总结一下："),t("code",[s._v("代数效应")]),s._v("能够将"),t("code",[s._v("副作用")]),s._v("（例子中为"),t("code",[s._v("请求图片数量")]),s._v("）从函数逻辑中分离，使函数关注点保持纯粹。")]),s._v(" "),t("p",[s._v("并且，从例子中可以看出，"),t("code",[s._v("perform resume")]),s._v("不需要区分同步异步。")]),s._v(" "),t("h2",{attrs:{id:"代数效应在react中的应用"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#代数效应在react中的应用"}},[s._v("#")]),s._v(" 代数效应在React中的应用")]),s._v(" "),t("p",[s._v("那么"),t("code",[s._v("代数效应")]),s._v("与"),t("code",[s._v("React")]),s._v("有什么关系呢？最明显的例子就是"),t("code",[s._v("Hooks")]),s._v("。")]),s._v(" "),t("p",[s._v("对于类似"),t("code",[s._v("useState")]),s._v("、"),t("code",[s._v("useReducer")]),s._v("、"),t("code",[s._v("useRef")]),s._v("这样的"),t("code",[s._v("Hook")]),s._v("，我们不需要关注"),t("code",[s._v("FunctionComponent")]),s._v("的"),t("code",[s._v("state")]),s._v("在"),t("code",[s._v("Hook")]),s._v("中是如何保存的，"),t("code",[s._v("React")]),s._v("会为我们处理。")]),s._v(" "),t("p",[s._v("我们只需要假设"),t("code",[s._v("useState")]),s._v("返回的是我们想要的"),t("code",[s._v("state")]),s._v("，并编写业务逻辑就行。")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("App")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("num"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" updateNum"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("useState")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  \n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("button onClick"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("updateNum")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("num")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" num "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("num"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("button"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  \n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("如果这个例子还不够明显，可以看看官方的"),t("a",{attrs:{href:"https://codesandbox.io/s/frosty-hermann-bztrp?file=/src/index.js:152-160",target:"_blank",rel:"noopener noreferrer"}},[s._v("Suspense Demo"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("在"),t("code",[s._v("Demo")]),s._v("中"),t("code",[s._v("ProfileDetails")]),s._v("用于展示"),t("code",[s._v("用户名称")]),s._v("。而"),t("code",[s._v("用户名称")]),s._v("是"),t("code",[s._v("异步请求")]),s._v("的。")]),s._v(" "),t("p",[s._v("但是"),t("code",[s._v("Demo")]),s._v("中完全是"),t("code",[s._v("同步")]),s._v("的写法。")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ProfileDetails")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" user "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" resource"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("user"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("read")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("h1"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("user"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("h1"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("h2",{attrs:{id:"代数效应与generator"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#代数效应与generator"}},[s._v("#")]),s._v(" 代数效应与Generator")]),s._v(" "),t("p",[s._v("从"),t("code",[s._v("React15")]),s._v("到"),t("code",[s._v("React16")]),s._v("，协调器（"),t("code",[s._v("Reconciler")]),s._v("）重构的一大目的是：将老的"),t("code",[s._v("同步更新")]),s._v("的架构变为"),t("code",[s._v("异步可中断更新")]),s._v("。")]),s._v(" "),t("p",[t("code",[s._v("异步可中断更新")]),s._v("可以理解为："),t("code",[s._v("更新")]),s._v("在执行过程中可能会被打断（浏览器时间分片用尽或有更高优任务插队），当可以继续执行时恢复之前执行的中间状态。")]),s._v(" "),t("p",[s._v("这就是"),t("code",[s._v("代数效应")]),s._v("中"),t("code",[s._v("try...handle")]),s._v("的作用。")]),s._v(" "),t("p",[s._v("其实，浏览器原生就支持类似的实现，这就是"),t("code",[s._v("Generator")]),s._v("。")]),s._v(" "),t("p",[s._v("但是"),t("code",[s._v("Generator")]),s._v("的一些缺陷使"),t("code",[s._v("React")]),s._v("团队放弃了他：")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("类似"),t("code",[s._v("async")]),s._v("，"),t("code",[s._v("Generator")]),s._v("也是"),t("code",[s._v("传染性")]),s._v("的，使用了"),t("code",[s._v("Generator")]),s._v("则上下文的其他函数也需要作出改变。这样心智负担比较重。")])]),s._v(" "),t("li",[t("p",[t("code",[s._v("Generator")]),s._v("执行的"),t("code",[s._v("中间状态")]),s._v("是上下文关联的。")])])]),s._v(" "),t("p",[s._v("考虑如下例子：")]),s._v(" "),t("div",{staticClass:"language-js line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-js"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("doWork")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token parameter"}},[t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("A")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("B")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("C")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),s._v(" x "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("doExpensiveWorkA")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("A")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("yield")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),s._v(" y "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" x "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("doExpensiveWorkB")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("B")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("yield")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("var")]),s._v(" z "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" y "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("doExpensiveWorkC")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("C")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" z"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")]),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("每当浏览器有空闲时间都会依次执行其中一个"),t("code",[s._v("doExpensiveWork")]),s._v("，当时间用尽则会中断，当再次恢复时会从中断位置继续执行。")]),s._v(" "),t("p",[s._v("只考虑“单一优先级任务的中断与继续”情况下"),t("code",[s._v("Generator")]),s._v("可以很好的实现"),t("code",[s._v("异步可中断更新")]),s._v("。")]),s._v(" "),t("p",[s._v("但是当我们考虑“高优先级任务插队”的情况，如果此时已经完成"),t("code",[s._v("doExpensiveWorkA")]),s._v("与"),t("code",[s._v("doExpensiveWorkB")]),s._v("计算出"),t("code",[s._v("x")]),s._v("与"),t("code",[s._v("y")]),s._v("。")]),s._v(" "),t("p",[s._v("此时"),t("code",[s._v("B")]),s._v("组件接收到一个"),t("code",[s._v("高优更新")]),s._v("，由于"),t("code",[s._v("Generator")]),s._v("执行的"),t("code",[s._v("中间状态")]),s._v("是上下文关联的，所以计算"),t("code",[s._v("y")]),s._v("时无法复用之前已经计算出的"),t("code",[s._v("x")]),s._v("，需要重新计算。")]),s._v(" "),t("p",[s._v("如果通过"),t("code",[s._v("全局变量")]),s._v("保存之前执行的"),t("code",[s._v("中间状态")]),s._v("，又会引入新的复杂度。")]),s._v(" "),t("blockquote",[t("p",[s._v("更详细的解释可以参考"),t("a",{attrs:{href:"https://github.com/facebook/react/issues/7942#issuecomment-254987818",target:"_blank",rel:"noopener noreferrer"}},[s._v("这个issue"),t("OutboundLink")],1)])]),s._v(" "),t("p",[s._v("基于这些原因，"),t("code",[s._v("React")]),s._v("没有采用"),t("code",[s._v("Generator")]),s._v("实现"),t("code",[s._v("协调器")]),s._v("。")]),s._v(" "),t("h2",{attrs:{id:"代数效应与fiber"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#代数效应与fiber"}},[s._v("#")]),s._v(" 代数效应与Fiber")]),s._v(" "),t("p",[t("code",[s._v("Fiber")]),s._v("并不是计算机术语中的新名词，他的中文翻译叫做"),t("code",[s._v("纤程")]),s._v("，与进程（Process）、线程（Thread）、协程（Coroutine）同为程序执行过程。")]),s._v(" "),t("p",[s._v("在很多文章中将"),t("code",[s._v("纤程")]),s._v("理解为"),t("code",[s._v("协程")]),s._v("的一种实现。在"),t("code",[s._v("JS")]),s._v("中，"),t("code",[s._v("协程")]),s._v("的实现便是"),t("code",[s._v("Generator")]),s._v("。")]),s._v(" "),t("p",[s._v("所以，我们可以将"),t("code",[s._v("纤程")]),s._v("(Fiber)、"),t("code",[s._v("协程")]),s._v("(Generator)理解为"),t("code",[s._v("代数效应")]),s._v("思想在"),t("code",[s._v("JS")]),s._v("中的体现。")]),s._v(" "),t("p",[t("code",[s._v("React Fiber")]),s._v("可以理解为：")]),s._v(" "),t("p",[t("code",[s._v("React")]),s._v("内部实现的一套状态更新机制。支持任务不同"),t("code",[s._v("优先级")]),s._v("，可中断与恢复，并且恢复后可以复用之前的"),t("code",[s._v("中间状态")]),s._v("。")]),s._v(" "),t("p",[s._v("其中每个任务更新单元为"),t("code",[s._v("React Element")]),s._v("对应的"),t("code",[s._v("Fiber节点")]),s._v("。")]),s._v(" "),t("p",[s._v("下一节，我们具体讲解"),t("code",[s._v("Fiber架构")]),s._v("的实现。")])])}),[],!1,null,null,null);t.default=e.exports}}]);